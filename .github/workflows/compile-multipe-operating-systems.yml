name: ðŸ”‹ Compile on multiple operating systems for Lilygo T-CAN

on:
  # The workflow is run when a commit is pushed or for a
  # Pull Request.
  - push
  - pull_request

# This is the list of jobs that will be run concurrently.
jobs:
  # This pre-job is run to skip workflows in case a workflow is already run, i.e. because the workflow is triggered by both push and pull_request
  skip-duplicate-actions:
    runs-on: ubuntu-latest
    # Map a step output to a job output
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          # All of these options are optional, so you can remove them if you are happy with the defaults
          concurrent_skipping: 'never'
          skip_after_successful_duplicate: 'true'
          do_not_skip: '["pull_request", "workflow_dispatch", "schedule"]'

  build-on-operating-systems:
    strategy:
      # fail-fast false ensures that all OS-builds will be run, despite one build failing
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v6
      name: Checkout code

    - uses: actions/cache@v5
      with:
        path: |
          ~/.cache/pip
          ~/.platformio/.cache
        key: ${{ runner.os }}-pio

    - name: Set up Python 3.14
      uses: actions/setup-python@v6
      with:
        python-version: '3.14'

    - name: Install PlatformIO Core
      run: pip install --upgrade platformio

    - name: Build image for Lilygo
      run: pio run -e lilygo_330
